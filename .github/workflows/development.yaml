on:
  pull_request:
    branches:
      - mainline/development

name: 🧪 Code Quality and Testing

jobs:
  # Job to cache Composer and NPM dependencies
  cache-dependencies:
    name: 📦 Cache Dependencies
    runs-on: ubuntu-22.04
    steps:
      - name: 📥 Get latest code
        uses: actions/checkout@v2

      - name: 🛠️ Set up PHP
        uses: shivammathur/setup-php@v2
        with:
          php-version: '8.2'
          tools: composer

      - name: 🔍 Get Composer and NPM Cache Directories
        id: cache-dirs
        run: |
          echo "COMPOSER_CACHE_DIR=$(composer config cache-files-dir)" >> $GITHUB_ENV
          echo "NPM_CACHE_DIR=$(npm config get cache)" >> $GITHUB_ENV
          
      - name: 📦 Cache Composer and NPM dependencies
        uses: actions/cache@v2
        with:
          path: |
            ${{ env.COMPOSER_CACHE_DIR }}
            ${{ env.NPM_CACHE_DIR }}
          key: ${{ runner.os }}-dependencies-${{ hashFiles('**/composer.json', '**/package.json') }}
          restore-keys: ${{ runner.os }}-dependencies

      - name: ⚡ Validate composer.json and composer.lock
        run: composer validate --strict
      
      - name: 📚 Install Composer Dependencies
        run: composer install --no-progress --optimize-autoloader
      
      - name: 📚 Install Node.js Dependencies
        run: npm install --no-progress

  # Job for running linter
  run-linter:
    name: 📋 Run Linter (phplint)
    runs-on: ubuntu-22.04
    needs: cache-dependencies
    steps:
      - run: composer lint

  # Job for checking coding standards
  check-coding-standards:
    name: 📋 Check Coding Standards (phpcs)
    runs-on: ubuntu-22.04
    needs: cache-dependencies
    steps:
      - run: composer phpcs

  # Job for running PHP Mess Detector
  run-phpmd:
    name: 📋 Run PHP Mess Detector (phpmd)
    runs-on: ubuntu-22.04
    needs: cache-dependencies
    steps:
      - run: composer phpmd
      
  # Job for checking code quality with Psalm
  check-code-quality:
    name: 🔍 Check for Code Quality (psalm)
    runs-on: ubuntu-22.04
    needs: cache-dependencies
    steps:
      - run: composer psalm

  # Job for running Unit Testing
  unit-tests:
    name: ✅ Unit Tests
    runs-on: ubuntu-22.04
    needs: cache-dependencies
    steps:
      - run: composer phpunit
