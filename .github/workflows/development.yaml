on:
  pull_request:
    branches:
      - mainline/development

name: ðŸ§ª Code Quality and Testing

jobs:
  # Job to cache Composer and NPM dependencies
  cache-dependencies:
    name: ðŸ“¦ Cache Dependencies
    runs-on: ubuntu-22.04
    steps:
      - name: ðŸ“¥ Get latest code
        uses: actions/checkout@v2

      - name: ðŸ› ï¸ Set up PHP
        uses: shivammathur/setup-php@v2
        with:
          php-version: '8.2'
          tools: composer

      - name: ðŸ” Get Composer and NPM Cache Directories
        id: cache-dirs
        run: |
          echo "COMPOSER_CACHE_DIR=$(composer config cache-files-dir)" >> $GITHUB_ENV
          echo "NPM_CACHE_DIR=$(npm config get cache)" >> $GITHUB_ENV
          
      - name: ðŸ“¦ Cache Composer and NPM dependencies
        uses: actions/cache@v2
        with:
          path: |
            ${{ env.COMPOSER_CACHE_DIR }}
            ${{ env.NPM_CACHE_DIR }}
          key: ${{ runner.os }}-dependencies-${{ hashFiles('**/composer.json', '**/package.json') }}
          restore-keys: ${{ runner.os }}-dependencies

      - name: âš¡ Validate composer.json and composer.lock
        run: composer validate --strict
      
      - name: ðŸ“š Install Composer Dependencies
        run: composer install --no-progress --optimize-autoloader
      
      - name: ðŸ“š Install Node.js Dependencies
        run: npm install --no-progress

  # Job for running linter
  run-linter:
    name: ðŸ“‹ Run Linter (phplint)
    runs-on: ubuntu-22.04
    needs: cache-dependencies
    steps:
      - name: ðŸ“¥ Get latest code
        uses: actions/checkout@v2

      - name: ðŸ› ï¸ Set up PHP
        uses: shivammathur/setup-php@v2
        with:
          php-version: '8.2'
          tools: composer

      - name: ðŸ” Get Composer and NPM Cache Directories
        id: cache-dirs
        run: |
          echo "COMPOSER_CACHE_DIR=$(composer config cache-files-dir)" >> $GITHUB_ENV
          echo "NPM_CACHE_DIR=$(npm config get cache)" >> $GITHUB_ENV
          
      - name: ðŸ“¦ Cache Composer and NPM dependencies
        uses: actions/cache@v2
        with:
          path: |
            ${{ env.COMPOSER_CACHE_DIR }}
            ${{ env.NPM_CACHE_DIR }}
          key: ${{ runner.os }}-dependencies-${{ hashFiles('**/composer.json', '**/package.json') }}
          restore-keys: ${{ runner.os }}-dependencies

      - name: ðŸ“š Install Composer Dependencies
        run: composer install --no-progress --optimize-autoloader

      - name: ðŸ“‹ Run linter (phplint)
        run: composer lint

  # Job for checking coding standards
  check-coding-standards:
    name: ðŸ“‹ Check Coding Standards (phpcs)
    runs-on: ubuntu-22.04
    needs: cache-dependencies
    steps:
      - name: ðŸ“¥ Get latest code
        uses: actions/checkout@v2

      - name: ðŸ› ï¸ Set up PHP
        uses: shivammathur/setup-php@v2
        with:
          php-version: '8.2'
          tools: composer

      - name: ðŸ” Get Composer and NPM Cache Directories
        id: cache-dirs
        run: |
          echo "COMPOSER_CACHE_DIR=$(composer config cache-files-dir)" >> $GITHUB_ENV
          echo "NPM_CACHE_DIR=$(npm config get cache)" >> $GITHUB_ENV
          
      - name: ðŸ“¦ Cache Composer and NPM dependencies
        uses: actions/cache@v2
        with:
          path: |
            ${{ env.COMPOSER_CACHE_DIR }}
            ${{ env.NPM_CACHE_DIR }}
          key: ${{ runner.os }}-dependencies-${{ hashFiles('**/composer.json', '**/package.json') }}
          restore-keys: ${{ runner.os }}-dependencies

      - name: ðŸ“š Install Composer Dependencies
        run: composer install --no-progress --optimize-autoloader

      - name: ðŸ“‹ Check Coding Standards (phpcs)
        run: composer phpcs

  # Job for running PHP Mess Detector
  run-phpmd:
    name: ðŸ“‹ Run PHP Mess Detector (phpmd)
    runs-on: ubuntu-22.04
    needs: cache-dependencies
    steps:
      - name: ðŸ“¥ Get latest code
        uses: actions/checkout@v2

      - name: ðŸ› ï¸ Set up PHP
        uses: shivammathur/setup-php@v2
        with:
          php-version: '8.2'
          tools: composer

      - name: ðŸ” Get Composer and NPM Cache Directories
        id: cache-dirs
        run: |
          echo "COMPOSER_CACHE_DIR=$(composer config cache-files-dir)" >> $GITHUB_ENV
          echo "NPM_CACHE_DIR=$(npm config get cache)" >> $GITHUB_ENV
          
      - name: ðŸ“¦ Cache Composer and NPM dependencies
        uses: actions/cache@v2
        with:
          path: |
            ${{ env.COMPOSER_CACHE_DIR }}
            ${{ env.NPM_CACHE_DIR }}
          key: ${{ runner.os }}-dependencies-${{ hashFiles('**/composer.json', '**/package.json') }}
          restore-keys: ${{ runner.os }}-dependencies

      - name: ðŸ“š Install Composer Dependencies
        run: composer install --no-progress --optimize-autoloader

      - name: ðŸ“‹ Run PHP Mess Detector (phpmd)
        run: composer phpmd
      
  # Job for checking code quality with Psalm
  check-code-quality:
    name: ðŸ” Check for Code Quality (psalm)
    runs-on: ubuntu-22.04
    needs: cache-dependencies
    steps:
      - name: ðŸ“¥ Get latest code
        uses: actions/checkout@v2

      - name: ðŸ› ï¸ Set up PHP
        uses: shivammathur/setup-php@v2
        with:
          php-version: '8.2'
          tools: composer

      - name: ðŸ” Get Composer and NPM Cache Directories
        id: cache-dirs
        run: |
          echo "COMPOSER_CACHE_DIR=$(composer config cache-files-dir)" >> $GITHUB_ENV
          echo "NPM_CACHE_DIR=$(npm config get cache)" >> $GITHUB_ENV
          
      - name: ðŸ“¦ Cache Composer and NPM dependencies
        uses: actions/cache@v2
        with:
          path: |
            ${{ env.COMPOSER_CACHE_DIR }}
            ${{ env.NPM_CACHE_DIR }}
          key: ${{ runner.os }}-dependencies-${{ hashFiles('**/composer.json', '**/package.json') }}
          restore-keys: ${{ runner.os }}-dependencies

      - name: ðŸ“š Install Composer Dependencies
        run: composer install --no-progress --optimize-autoloader

      - name: ðŸ” Check for Code Quality (psalm)
        run: composer psalm

  # Job for running Unit Testing
  unit-tests:
    name: âœ… Unit Tests
    runs-on: ubuntu-22.04
    needs: cache-dependencies
    steps:
      - name: ðŸ“¥ Get latest code
        uses: actions/checkout@v2

      - name: ðŸ› ï¸ Set up PHP
        uses: shivammathur/setup-php@v2
        with:
          php-version: '8.2'
          tools: composer

      - name: ðŸ” Get Composer and NPM Cache Directories
        id: cache-dirs
        run: |
          echo "COMPOSER_CACHE_DIR=$(composer config cache-files-dir)" >> $GITHUB_ENV
          echo "NPM_CACHE_DIR=$(npm config get cache)" >> $GITHUB_ENV
          
      - name: ðŸ“¦ Cache Composer and NPM dependencies
        uses: actions/cache@v2
        with:
          path: |
            ${{ env.COMPOSER_CACHE_DIR }}
            ${{ env.NPM_CACHE_DIR }}
          key: ${{ runner.os }}-dependencies-${{ hashFiles('**/composer.json', '**/package.json') }}
          restore-keys: ${{ runner.os }}-dependencies

      - name: ðŸ“š Install Composer Dependencies
        run: composer install --no-progress --optimize-autoloader

      - name: âœ… Run Unit Tests (phpunit)
        run: composer phpunit
